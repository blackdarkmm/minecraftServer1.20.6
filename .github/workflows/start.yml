name: Fabric Server - 雲端世界備份 (ZeroTier VPN)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-again]

jobs:
  minecraft:
    runs-on: ubuntu-latest

    env:
        RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
        RCON_PORT: ${{ secrets.RCON_PORT }}

    steps:
      - name: 檢出 repo 檔案
        uses: actions/checkout@v4

      - name: 安裝 Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: 安裝 Python 和 gdown
        run: |
          sudo apt update
          sudo apt install python3-pip unzip
          pip install gdown

      - name: 安裝 screen
        run: sudo apt-get install -y screen

      - name: 下載 world.zip（從 Google Drive）
        env:
          FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
        run: |
          echo "從 Google Drive 下載 world.zip..."
          gdown --id $FILE_ID -O world.zip

      - name: 解壓縮世界檔案（如有）
        run: |
          if [ -f world.zip ]; then
            echo "Found world.zip, attempting unzip..."
            unzip world.zip
          else
            echo "No world.zip found, skipping unzip."
          fi

      - name: 安裝 ZeroTier CLI
        run: |
          curl -s https://install.zerotier.com | sudo bash

      - name: 匯入 ZeroTier 身份檔案（保證固定 IP）
        run: |
          sudo systemctl stop zerotier-one

          echo "${{ secrets.ZT_IDENTITY_SECRET }}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret

          sudo systemctl start zerotier-one

          echo "等待 identity.public 生成..."
          for i in {1..10}; do
            if [ -f /var/lib/zerotier-one/identity.public ]; then
              echo "✅ identity.public 已生成"
              break
            fi
            echo "⏳ identity.public 尚未出現，等待 1 秒..."
            sleep 1
          done

          echo "目前身份："
          sudo cat /var/lib/zerotier-one/identity.public || echo "⚠️ 無法讀取身份"

      - name: 加入 ZeroTier 網路
        env:
          ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
        run: |
          sudo zerotier-cli join $ZT_NETWORK_ID
          echo "等待 ZeroTier 加入網路..."
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep $ZT_NETWORK_ID | awk '{print $5}')
            echo "目前狀態：$STATUS"
            if [[ "$STATUS" == "OK" ]]; then
              echo "✅ 已成功加入 ZeroTier 網路"
              break
            fi
            sleep 3
          done

      - name: 顯示 ZeroTier IP
        run: sudo zerotier-cli listnetworks

      - name: 顯示 ZeroTier 身份檔案（只用一次）
        run: |
          echo "========== BEGIN identity.secret =========="
          sudo cat /var/lib/zerotier-one/identity.secret
          echo "=========== END identity.secret ==========="

      - name: 啟動 Fabric Server（使用 screen）
        run: |
          screen -dmS minecraft java -Xmx6G -Xms6G -jar fabric-server-launch.jar nogui
          sleep 30

      - name: Minecraft Server 運行中（等待）
        run: |
          echo "伺服器將保持運行 5 小時..."
          sleep 18000

      - name: 優雅關閉 Minecraft 伺服器
        run: |
          screen -S minecraft -p 0 -X stuff "stop$(printf \\r)"
          sleep 15

      - name: 壓縮世界
        run: zip -r world.zip world

      - name: 安裝 rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: 寫入 rclone 設定檔（base64）
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: 上傳 world.zip 到 Google Drive
        run: |
          echo "上傳 world.zip 到 Google Drive..."
          rclone copy world.zip gdrive:minecraft_world \
            --drive-chunk-size 16M \
            --transfers=1 \
            --retries=10 \
            --low-level-retries=20 \
            --progress

      # 最後一個 step 觸發自己重新執行
      - name: 觸發下一次執行
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-again
